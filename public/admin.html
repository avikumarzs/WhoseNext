<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Control Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <header>
        <h1>‚öôÔ∏è Control Center</h1>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">üåô</button>
    </header>

    <div class="dashboard-container">
        <div class="sidebar">
            <a href="/results" class="btn-primary" style="text-decoration:none; display:block; text-align:center; background: var(--accent); color: white; margin-bottom: 1.5rem; font-weight: 800;">
                üìã Go to Selection Board
            </a>

            <div style="background: var(--bg-main); padding: 1rem; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 1rem;">
                <div class="input-group">
                    <label>Current Company</label>
                    <input type="text" id="companyInput" placeholder="Ex: Google">
                </div>
                <button class="btn-primary" style="padding: 0.5rem;" onclick="updateCompany()">Set Branding</button>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin-bottom: 1.5rem;">

            <h3 style="color:var(--text-main);">Add Candidate</h3>
            <div class="input-group">
                <label>Name</label> <input type="text" id="name" placeholder="John Doe">
            </div>
            <div class="input-group">
                <label>Room Path</label> <input type="text" id="room" placeholder="203, 302, HR">
            </div>
            <button class="btn-primary" onclick="addStudent()">Add to Queue</button>
            
            <div style="margin-top: 1.5rem;">
                <label style="cursor: pointer; border: 2px dashed var(--border); padding: 1rem; border-radius: 8px; text-align: center; display: block; color: var(--text-muted); font-size: 0.85rem; transition: 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                    üìÇ <b>Upload Excel File</b><br>
                    <span style="font-size: 0.75rem; opacity: 0.8;">(.xlsx files only)</span>
                    <input type="file" id="excelFile" accept=".xlsx" onchange="handleExcelUpload()" style="display: none;">
                </label>
                <div id="uploadStatus" style="font-size: 0.8rem; color: var(--accent); text-align: center; margin-top: 5px; height: 15px;"></div>
            </div>
            <button onclick="resetSystem()" style="background: #ff4757; color: white; margin-top: 2rem; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 800; opacity: 0.6;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                üóëÔ∏è Reset System for New Drive
            </button>
        </div>

        <div class="main-content">
            <div class="stats-container" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card">
                    <span class="label">Total in Queue</span>
                    <span class="value" id="stat-total">0</span>
                </div>
                <div class="stat-card" style="border-top: 4px solid var(--success);">
                    <span class="label">Interviewing</span>
                    <span class="value" id="stat-active">0</span>
                </div>
                <div class="stat-card" style="border-top: 4px solid var(--warning);">
                    <span class="label">Waiting</span>
                    <span class="value" id="stat-waiting">0</span>
                </div>
                <div class="stat-card" style="border-top: 4px solid var(--primary);">
                    <span class="label">Current Drive</span>
                    <span class="value" id="stat-company" style="font-size: 1.1rem; line-height: 2.2;">-</span>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="font-size: 1.1rem; color: var(--text-muted); text-transform: uppercase;">Active Queue</h2>
                <button onclick="loadQueue()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;" title="Refresh List">üîÑ</button>
            </div>

            <div style="margin-bottom: 1.5rem; position: relative;">
                <input type="text" id="adminSearch" onkeyup="filterQueue()" placeholder="üîç Search for candidate" 
                    style="width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--text-main); font-size: 0.95rem; outline: none; transition: 0.3s;"
                    onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
            </div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>#</th> <th>Name</th> <th>Status</th> <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="adminList"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- 1. THEME INITIALIZER (Runs instantly) ---
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        })();

        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const toggleBtn = document.querySelector('.theme-toggle');
            if (savedTheme === 'dark' && toggleBtn) {
                toggleBtn.innerText = '‚òÄÔ∏è';
            }
        });

        // --- 2. THEME TOGGLE FUNCTION ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            const icon = isDark ? '‚òÄÔ∏è' : 'üåô';
            document.querySelector('.theme-toggle').innerText = icon;
        }

        // --- 3. COMPANY BRANDING ---
        async function updateCompany() {
            const company = document.getElementById('companyInput').value;
            await fetch('/set-company', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ company }) });
            document.getElementById('stat-company').innerText = company; 
            alert("Company Name Updated on Display Board!");
        }

        async function getCompany() {
            try {
                const res = await fetch('/get-company');
                const data = await res.json();
                document.getElementById('stat-company').innerText = data.company;
            } catch(e) {}
        }

        // --- 4. EXCEL UPLOAD LOGIC ---
        function handleExcelUpload() {
            const fileInput = document.getElementById('excelFile');
            const statusDiv = document.getElementById('uploadStatus');
            if (fileInput.files.length === 0) return;
            const file = fileInput.files[0];
            statusDiv.innerText = "Processing...";
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);
                    let count = 0;
                    for(let row of jsonData) {
                        const getVal = (obj, keys) => {
                            const foundKey = Object.keys(obj).find(k => keys.includes(k.toLowerCase()));
                            return foundKey ? obj[foundKey] : null;
                        };
                        const name = getVal(row, ['name', 'candidate name', 'student name', 'candidate']);
                        const room = getVal(row, ['room', 'path', 'location', 'rounds']) || "Waiting Area";
                        if(name) {
                            await fetch('/add-student', { 
                                method: 'POST', 
                                headers: {'Content-Type':'application/json'}, 
                                body: JSON.stringify({ name: String(name), room: String(room) }) 
                            });
                            count++;
                        }
                    }
                    statusDiv.innerText = "Done!";
                    alert(`‚úÖ Successfully added ${count} candidates from Excel.`);
                    fileInput.value = ""; 
                    loadQueue(); 
                } catch (err) {
                    alert("Error reading Excel file.");
                    statusDiv.innerText = "Error";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 5. MANUAL ADD ---
        async function addStudent() {
            const name = document.getElementById('name').value;
            const room = document.getElementById('room').value;
            if(name) {
                await fetch('/add-student', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name, room }) });
                document.getElementById('name').value = ''; 
                document.getElementById('room').value = ''; 
                loadQueue();
            } else {
                alert("Please enter a Name");
            }
        }

        // --- 6. LOAD QUEUE & STATS ---
        async function loadQueue() {
            const res = await fetch('/get-queue');
            const data = await res.json();
            const list = document.getElementById('adminList');
            list.innerHTML = '';

            // Case-insensitive stats calculation
            const activeCount = data.filter(s => s.status && s.status.toLowerCase() === 'interviewing').length;
            const waitingCount = data.filter(s => s.status && s.status.toLowerCase() === 'waiting').length;

            document.getElementById('stat-total').innerText = data.length;
            document.getElementById('stat-active').innerText = activeCount;
            document.getElementById('stat-waiting').innerText = waitingCount;

            if(data.length === 0) {
                list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:2rem; color:var(--text-muted);">Queue is empty</td></tr>';
                return;
            }

            data.forEach((s, i) => {
                const currentRoom = s.path[s.currentStep] || "Finish";
                const isLast = s.currentStep >= s.path.length - 1;
                const currentStatus = s.status ? s.status.toLowerCase() : '';
                let btn = '';

                if (currentStatus === 'waiting') {
                    btn = `<button class="btn-call" onclick="sendAction(${i}, 'call')">üì¢ Call In</button>`;
                } else {
                    if (isLast) btn = `<button class="btn-done" onclick="sendAction(${i}, 'finish')">‚úì Finish</button>`;
                    else btn = `<button class="btn-primary" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="sendAction(${i}, 'next')">‚ûù Send to ${s.path[s.currentStep+1]}</button>`;
                }

                list.innerHTML += `
                    <tr>
                        <td>${i+1}</td> 
                        <td style="font-weight:600;">${s.name}</td>
                        <td>
                            <span class="badge ${currentStatus === 'waiting' ? 'badge-waiting' : 'badge-interviewing'}">
                                ${currentStatus === 'waiting' ? 'Waiting: ' + currentRoom : 'Inside: ' + currentRoom}
                            </span>
                        </td>
                        <td style="text-align:right;">
                            ${btn} 
                            <button onclick="remove(${i})" class="btn-del btn-icon" title="Remove">‚úï</button>
                        </td>
                    </tr>`;
            });
            filterQueue();
        }
        
        async function sendAction(i, action) { await fetch('/update-status', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ index: i, action }) }); loadQueue(); }
        async function remove(i) { if(confirm("Remove this student?")) { await fetch(`/remove-student/${i}`, { method: 'DELETE' }); loadQueue(); } }
        
        const socket = io();
        socket.on('queueUpdated', async () => {
            await loadQueue();
            filterQueue();
        });

        // --- 7. RESET SYSTEM ---
        async function resetSystem() {
            if (confirm("üö® WARNING: This will PERMANENTLY DELETE all student data and decisions. Are you sure?")) {
                const password = prompt("Type 'RESET' to confirm:");
                if (password === 'RESET') {
                    await fetch('/reset-all', { method: 'POST' });
                    alert("System has been cleared.");
                    loadQueue(); 
                }
            }
        }

        // --- 8. SEARCH FILTER ---
        function filterQueue() {
            const input = document.getElementById('adminSearch');
            const query = input.value.toLowerCase().trim();
            const tbody = document.querySelector('.data-table tbody');
            const oldAlert = tbody.querySelector('.no-results-row');
            if (oldAlert) oldAlert.remove();
            
            const rows = tbody.querySelectorAll('tr');
            let matchCount = 0;
            
            rows.forEach(row => {
                const nameCell = row.cells[1];
                if (nameCell) {
                    const name = nameCell.textContent.toLowerCase();
                    if (name.includes(query)) {
                        row.style.display = "";
                        matchCount++;
                    } else {
                        row.style.display = "none";
                    }
                }
            });
            
            if (query !== "" && matchCount === 0) {
                const noResultRow = document.createElement('tr');
                noResultRow.className = 'no-results-row';
                noResultRow.innerHTML = `<td colspan="100%" style="text-align:center; padding:2rem; color:var(--text-muted); font-style:italic;">üîç No candidates found matching "${input.value}"</td>`;
                tbody.appendChild(noResultRow);
            }
        }

        // Initial Load
        getCompany();
        loadQueue();
    </script>
</body>
</html>